service: myapp
domain: myapp.com
image: myapp

servers:
  web:
    - host: 192.168.1.10
      user: root
      ssh_key: ~/.ssh/id_rsa
      labels: [primary]
    - host: 192.168.1.11
      user: deploy

  worker:
    - host: 192.168.1.12
      user: root

registry:
  server: ghcr.io
  username: ${REGISTRY_USER}
  password: ${REGISTRY_PASSWORD}

dependencies:
  postgres:
    image: postgres:16
    port: 5432
    volume: postgres_data:/var/lib/postgresql/data
    env:
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: myapp
    # Deploy to primary server (default) or specify:
    # host: 192.168.1.20
    # role: db
    # labels: [database]
  
  redis:
    image: redis:7-alpine
    port: 6379
    # Example: deploy to cache server
    # labels: [cache]

services:
  web:
    port: 8000
    replicas: 2
    healthcheck:
      path: /health
      expect: [200, 301]
      timeout: 30s
      interval: 10s
    env:
      SECRET_KEY: ${SECRET_KEY}
      DATABASE_URL: postgres://postgres:${DB_PASSWORD}@primary:5432/myapp
      REDIS_URL: redis://primary:6379

  worker:
    command: celery -A myapp worker
    replicas: 1
    env:
      SECRET_KEY: ${SECRET_KEY}
      DATABASE_URL: postgres://postgres:${DB_PASSWORD}@primary:5432/myapp

proxy:
  enabled: true
  ssl: letsencrypt
  ssl_email: admin@myapp.com

hooks:
  after_deploy:
    - docker exec myapp-web-1 python manage.py migrate
    - docker exec myapp-web-1 python manage.py collectstatic --noinput

